// --- CONFIGURACIÓN ---
const SHEET_NAME = "Facturas";
const SPREADSHEET_ID = "1ShgCFbg3KBMNHiQgTvnBVuUhnz_jS_TiFMJLeHGH504";
const FOLDER_NAME = "facturas digitalencia"; // Nombre de la carpeta en Drive

function doPost(e) {
  const lock = LockService.getScriptLock();
  lock.tryLock(10000); 

  // --- DEBUGGING: LOG TO SHEET ---
  let debugSheet;
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    debugSheet = ss.getSheetByName("Logs");
    if (!debugSheet) {
      debugSheet = ss.insertSheet("Logs");
      debugSheet.appendRow(["Timestamp", "Type", "Data/Error"]);
    }
  } catch(e) {
    // If we can't open the sheet, we can't log.
    return ContentService.createTextOutput("Critical Error: Cannot access Spreadsheet. Check ID.");
  }

  try {
    const jsonString = e.parameter.payload; 
    let payloadToLog = jsonString;
    
    if (!jsonString && e.postData && e.postData.contents) {
      payloadToLog = e.postData.contents;
    }

    debugSheet.appendRow([new Date(), "Incoming Request", payloadToLog || "No Payload"]);

    // Reuse parsing logic
    let finalJsonString = jsonString;
    if (!finalJsonString && e.postData && e.postData.contents) {
      finalJsonString = e.postData.contents;
    }

    if (!finalJsonString) throw new Error("No payload received");

    const fullData = JSON.parse(finalJsonString);
    const sheetData = fullData.sheetData;
    const rawData = fullData.raw;

    if (!sheetData || !rawData) throw new Error("Invalid JSON Structure");

    // 1. GENERAR PDF
    const pdfFile = createInvoicePDF(rawData, sheetData);
    const pdfUrl = pdfFile.getUrl();

    // 2. ENVIAR EMAIL AL CLIENTE (Si existe)
    if (sheetData.clientEmail) {
      try {
        const subject = `Factura ${sheetData.invoiceNumber} - ${rawData.issuer.brand}`;
        const body = `Estimado cliente,\n\nAdjunto encontrará la factura Nº ${sheetData.invoiceNumber} correspondiente a los servicios prestados.\n\nAtentamente,\n${rawData.issuer.name}`;
        
        GmailApp.sendEmail(sheetData.clientEmail, subject, body, {
          attachments: [pdfFile.getAs(MimeType.PDF)],
          name: rawData.issuer.brand
        });
        debugSheet.appendRow([new Date(), "Email Sent", "To: " + sheetData.clientEmail]);
      } catch (emailError) {
        debugSheet.appendRow([new Date(), "Email Error", emailError.toString()]);
      }
    }

    // 3. ACTUALIZAR SHEET (insertar en la primera fila libre de la columna A)
    const sheet = getSheet();
    const newRow = [
      sheetData.invoiceNumber,
      sheetData.issueDate,
      sheetData.clientName,
      sheetData.clientTaxId,
      sheetData.baseTotal,
      sheetData.vatTypes,
      sheetData.vatTotalFormatted,
      sheetData.irpfPercent,
      sheetData.irpfAmountFormatted,
      sheetData.grandTotal,
      `=HYPERLINK("${pdfUrl}"; "Factura")`
    ];

    const lastRowA = sheet.getRange("A:A").getValues().filter(r => r[0] !== "").length;
    // lastRowA incluye el encabezado, así que si solo está la cabecera será 1 → insertará en la fila 2
    const targetRow = Math.max(2, lastRowA + 1);

    sheet.getRange(targetRow, 1, 1, newRow.length).setValues([newRow]);
    debugSheet.appendRow([new Date(), "Success", `Row ${targetRow} added for ${sheetData.invoiceNumber}`]);

    // 4. ACTUALIZAR RESUMEN FISCAL
    recalcResumenFiscal();

    return ContentService.createTextOutput("Success");

  } catch (error) {
    if(debugSheet) debugSheet.appendRow([new Date(), "Error", error.toString()]);
    return ContentService.createTextOutput("Error: " + error.toString());
  } finally {
    lock.releaseLock();
  }
}

// --- FUNCIÓN RECÁLCULO RESUMEN FISCAL (Integración AppSheet) ---
function recalcResumenFiscal() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName(SHEET_NAME);
  if (!sheet) return;

  const lastRowA = sheet.getRange("A:A").getValues().filter(r => r[0] !== "").length;
  if (lastRowA < 2) return; // solo cabecera

  // Facturas desde fila 2 hasta lastRowA
  const dataRange = sheet.getRange(2, 5, lastRowA - 1, 6); // E..J
  const data = dataRange.getValues();

  let sumBase = 0, sumIva = 0, sumIrpf = 0, sumTotal = 0;

  for (let i = 0; i < data.length; i++) {
    const row = data[i];
    sumBase += parseEuro(row[0]); // E
    sumIva  += parseEuro(row[2]); // G
    sumIrpf += parseEuro(row[4]); // I
    sumTotal+= parseEuro(row[5]); // J
  }

  const targets = [
    { label: "Base Imponible", value: sumBase },
    { label: "Total IVA", value: sumIva },
    { label: "Retención IRPF", value: sumIrpf },
    { label: "TOTAL NETO", value: sumTotal }
  ];

  const labelRange = sheet.getRange("N1:N30");
  const labels = labelRange.getValues();

  for (let t = 0; t < targets.length; t++) {
    const target = targets[t];
    for (let i = 0; i < labels.length; i++) {
      const cellValue = String(labels[i][0]);
      if (cellValue && cellValue.includes(target.label)) {
        sheet.getRange(i + 1, 15).setValue(target.value).setNumberFormat("#,##0.00 €"); // O
        break;
      }
    }
  }
}

// --- HELPER PARSEO MONEDA ROBUSTO ---
function parseEuro(value) {
  if (value == null || value === "") return 0;
  if (typeof value === 'number') return value;
  let s = String(value);
  s = s.replace(/[€\s]/g, '');
  s = s.replace(/\./g, '');
  s = s.replace(/,/g, '.');
  const result = parseFloat(s);
  return isNaN(result) ? 0 : result;
}

// --- FUNCIÓN GENERADORA DE PDF ---
function createInvoicePDF(data, formattedData) {
  const folders = DriveApp.getFoldersByName(FOLDER_NAME);
  let folder;
  if (folders.hasNext()) {
    folder = folders.next();
  } else {
    folder = DriveApp.createFolder(FOLDER_NAME);
  }

  const htmlTemplate = `
    <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; padding: 40px; color: #333; max-width: 800px; margin: 0 auto;">
      <div style="display: flex; justify-content: space-between; border-bottom: 2px solid #eee; padding-bottom: 20px; margin-bottom: 30px;">
        <div style="width: 50%;">
           ${formattedData.logoBase64 ? 
             `<img src="${formattedData.logoBase64}" alt="Logo" style="height: 60px; width: auto; margin-bottom: 10px;" />` : 
             `<h1 style="margin: 0; font-size: 28px; color: #333; font-weight: 300; letter-spacing: 1px;">FACTURA</h1>`
           }
           <p style="margin: 5px 0; color: #666; font-weight: bold;">#${formattedData.invoiceNumber}</p>
        </div>
        <div style="width: 50%; text-align: right;">
           <h3 style="margin: 0; color: #000; font-size: 16px;">${data.issuer.brand}</h3>
           <p style="margin: 3px 0; font-size: 12px; color: #555;">${data.issuer.name}</p>
           <p style="margin: 3px 0; font-size: 12px; color: #555;">${data.issuer.taxIdLabel}: ${data.issuer.taxId}</p>
           <p style="margin: 3px 0; font-size: 12px; color: #555; white-space: pre-line;">${data.issuer.address}</p>
        </div>
      </div>
      <div style="display: flex; margin-bottom: 40px;">
        <div style="width: 50%;">
            <h4 style="margin-bottom: 10px; color: #999; text-transform: uppercase; font-size: 10px; letter-spacing: 1px;">Facturar a:</h4>
            <p style="margin: 0; font-weight: bold; font-size: 14px;">${data.client.name}</p>
            <p style="margin: 3px 0; font-size: 12px; color: #555;">${data.client.taxIdLabel}: ${data.client.taxId}</p>
            <p style="margin: 3px 0; font-size: 12px; color: #555; white-space: pre-line;">${data.client.address}</p>
        </div>
        <div style="width: 50%; text-align: right;">
             <table style="width: 100%; font-size: 12px; color: #555;">
               <tr><td style="text-align: right; padding-bottom: 5px;"><strong>Fecha Emisión:</strong></td><td style="text-align: right; padding-bottom: 5px;">${formattedData.issueDate}</td></tr>
               <tr><td style="text-align: right;"><strong>Forma Pago:</strong></td><td style="text-align: right;">${data.invoice.paymentMethod}</td></tr>
             </table>
        </div>
      </div>
      <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
        <thead>
          <tr style="background-color: #f8f9fa; text-transform: uppercase;">
            <th style="padding: 12px 8px; text-align: left; font-size: 10px; color: #666; border-bottom: 1px solid #ddd;">Concepto</th>
            <th style="padding: 12px 8px; text-align: right; font-size: 10px; color: #666; border-bottom: 1px solid #ddd;">Cant.</th>
            <th style="padding: 12px 8px; text-align: right; font-size: 10px; color: #666; border-bottom: 1px solid #ddd;">Precio U.</th>
            <th style="padding: 12px 8px; text-align: right; font-size: 10px; color: #666; border-bottom: 1px solid #ddd;">Total</th>
          </tr>
        </thead>
        <tbody>
          ${data.items.map(item => `
            <tr>
              <td style="padding: 12px 8px; font-size: 12px; border-bottom: 1px solid #eee;">
                <strong>${item.title}</strong>
                ${item.detail ? `<br><span style="color: #777; font-size: 10px;">${item.detail}</span>` : ''}
              </td>
              <td style="padding: 12px 8px; text-align: right; font-size: 12px; border-bottom: 1px solid #eee;">${item.qty}</td>
              <td style="padding: 12px 8px; text-align: right; font-size: 12px; border-bottom: 1px solid #eee;">${item.unitPrice.toFixed(2)}</td>
              <td style="padding: 12px 8px; text-align: right; font-size: 12px; border-bottom: 1px solid #eee;">${(item.qty * item.unitPrice).toFixed(2)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
      <div style="margin-left: auto; width: 250px;">
         <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px;">
            <span>Base Imponible:</span>
            <span>${formattedData.baseTotal}</span>
         </div>
         <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px;">
            <span>IVA (${formattedData.vatTypes}):</span>
            <span>${formattedData.vatTotalFormatted}</span>
         </div>
         ${data.taxes.applyIrpf ? `
         <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px; color: #d00;">
            <span>IRPF (${formattedData.irpfPercent}):</span>
            <span>-${formattedData.irpfAmountFormatted}</span>
         </div>` : ''}
         <div style="display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 2px solid #333; font-size: 16px; font-weight: bold;">
            <span>TOTAL:</span>
            <span>${formattedData.grandTotal}</span>
         </div>
      </div>
      <div style="margin-top: 50px; padding-top: 20px; border-top: 1px solid #eee; text-align: center; font-size: 10px; color: #aaa;">
         <p>${data.invoice.notes ? data.invoice.notes.replace(/\n/g, ' ') : 'Gracias por su confianza.'}</p>
      </div>
    </div>
  `;

  const fileName = `Factura ${formattedData.invoiceNumber} - ${data.client.name}.pdf`;
  const blob = Utilities.newBlob(htmlTemplate, MimeType.HTML, fileName).getAs(MimeType.PDF);
  const file = folder.createFile(blob);
  file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
  return file;
}

function getSheet() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  let sheet = ss.getSheetByName(SHEET_NAME);
  if (!sheet) {
    sheet = ss.insertSheet(SHEET_NAME);
    sheet.appendRow(["Nº Factura", "Fecha Emisión", "Cliente", "NIF Cliente", "Base Imponible", "% IVA", "Total IVA", "% IRPF", "Retención IRPF", "TOTAL", "Link PDF"]);
    sheet.setFrozenRows(1);
    sheet.getRange(1, 1, 1, 11).setFontWeight("bold");
    updateSummarySkeleton(sheet);
  }
  return sheet;
}

function updateSummarySkeleton(sheet) {
  const startRow = 2;
  const colIndex = 14; 
  const headerRange = sheet.getRange(startRow, colIndex, 1, 2);
  headerRange.setBackground("#1155cc").setFontColor("#ffffff").setFontWeight("bold").setHorizontalAlignment("center");
  const bodyRange = sheet.getRange(startRow + 1, colIndex, 4, 2);
  bodyRange.setBackground("#f3f3f3").setFontColor("#000000").setBorder(true, true, true, true, true, true);
  sheet.getRange(startRow, colIndex).setValue("RESUMEN FISCAL");
  const labels = [["Base Imponible"], ["Total IVA"], ["Retención IRPF"], ["TOTAL NETO"]];
  sheet.getRange(startRow + 1, colIndex, 4, 1).setValues(labels).setFontWeight("bold");
}

// ==========================================
// NUEVA FUNCIONALIDAD: FILTRO POR FECHAS (V2)
// ==========================================

function onOpen() {
  SpreadsheetApp.getUi()
    .createMenu('Facturación')
    .addItem('Configurar Filtros de Fecha', 'setupDateFilters')
    .addItem('Calcular Total IVA (Manual)', 'forceCalculateIva')
    .addToUi();
}

// Configura los dropdowns y cabeceras en Q2-R2
function setupDateFilters() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_NAME);
  if (!sheet) {
    SpreadsheetApp.getUi().alert("No se encontró la hoja: " + SHEET_NAME);
    return;
  }

  // Cabeceras
  sheet.getRange("Q1").setValue("Desde Fecha").setFontWeight("bold").setBackground("#d9ead3");
  sheet.getRange("R1").setValue("Hasta Fecha").setFontWeight("bold").setBackground("#d9ead3");
  sheet.getRange("S1").setValue("Total IVA Rango").setFontWeight("bold").setBackground("#fff2cc");

  // Validación de datos (Dropdown fechas) en Q2 y R2
  // Usamos un validador de fecha más permisivo
  const rule = SpreadsheetApp.newDataValidation().requireDate().setAllowInvalid(true).build();
  sheet.getRange("Q2:R2").setDataValidation(rule);
  
  sheet.getRange("S2").setValue(0).setNumberFormat("#,##0.00 €");
  
  SpreadsheetApp.getUi().alert("Filtros configurados. Introduce fechas en Q2 y R2.");
}

// Trigger automático al editar celdas
function onEdit(e) {
  if (!e || !e.source) return;
  const sheet = e.source.getActiveSheet();
  if (sheet.getName() !== SHEET_NAME) return;

  const range = e.range;
  const row = range.getRow();
  const col = range.getColumn();

  // "Desde" = Q2 (17), "Hasta" = R2 (18)
  if (row === 2 && (col === 17 || col === 18)) {
    // Pequeño delay visual o toast
    e.source.toast("Calculando nuevo total...", "Facturación", 3);
    calculateIvaByDateRange(sheet);
  }
}

// Función manual para botón de menú
function forceCalculateIva() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_NAME);
  if (!sheet) return;
  
  SpreadsheetApp.getActiveSpreadsheet().toast("Iniciando cálculo...", "Status");
  calculateIvaByDateRange(sheet);
}

// Lógica de cálculo
function calculateIvaByDateRange(sheet) {
  const fromDateRaw = sheet.getRange("Q2").getValue();
  const toDateRaw = sheet.getRange("R2").getValue();
  const outputCell = sheet.getRange("S2");

  const fromDate = parseDateHelper(fromDateRaw);
  const toDate = parseDateHelper(toDateRaw);

  if (!fromDate || !toDate) {
    // Solo reseteamos si ambas están vacías. Si hay una, esperamos a la otra.
    // O mostramos mensaje de error en la celda
    if (!fromDateRaw && !toDateRaw) outputCell.setValue(0);
    return;
  }
  
  // Normalizar horas para comparar solo FECHAS
  fromDate.setHours(0,0,0,0);
  toDate.setHours(23,59,59,999);

  const lastRow = sheet.getLastRow();
  if (lastRow < 2) {
    outputCell.setValue(0);
    return;
  }

  // Rango desde fila 2 hasta final.
  // Col B (2) -> Col G (7)
  const dataRange = sheet.getRange(2, 2, lastRow - 1, 6);
  const values = dataRange.getValues();

  let totalIva = 0;
  let count = 0;

  for (let i = 0; i < values.length; i++) {
    // values[i][0] = Fecha Emisión
    // values[i][5] = Total IVA
    const rowDateRaw = values[i][0];
    const rowIvaRaw = values[i][5];

    const rowDate = parseDateHelper(rowDateRaw);

    if (rowDate) {
      // Normalizar hora fila
      rowDate.setHours(12,0,0,0); // Mediodía para evitar problemas de timezone

      if (rowDate >= fromDate && rowDate <= toDate) {
        totalIva += parseEuro(rowIvaRaw);
        count++;
      }
    }
  }

  outputCell.setValue(totalIva).setNumberFormat("#,##0.00 €");
  SpreadsheetApp.getActiveSpreadsheet().toast(`Cálculo completado. ${count} facturas encontradas.`, "Éxito");
}

function parseDateHelper(val) {
  if (!val) return null;
  if (val instanceof Date) return val;
  
  // Si es cadena
  if (typeof val === 'string') {
    // Caso DD/MM/YYYY
    if (val.includes('/')) {
      const parts = val.split('/');
      if (parts.length === 3) {
         // Asegurar que son números
         const d = parseInt(parts[0], 10);
         const m = parseInt(parts[1], 10) - 1; // Mes 0-index
         const y = parseInt(parts[2], 10);
         const dateObj = new Date(y, m, d);
         // Validar que es fecha válida
         if (!isNaN(dateObj.getTime())) return dateObj;
      }
    }
    // Caso ISO YYYY-MM-DD
    if (val.includes('-')) {
        const parts = val.split('-');
        if (parts.length === 3) {
            return new Date(parts[0], parts[1]-1, parts[2]);
        }
    }
  }
  
  // Fallback
  const d = new Date(val);
  return isNaN(d.getTime()) ? null : d;
}
