// --- CONFIGURACIÓN ---
const SHEET_NAME = "Facturas";
const SPREADSHEET_ID = "1ShgCFbg3KBMNHiQgTvnBVuUhnz_jS_TiFMJLeHGH504";
const FOLDER_NAME = "facturas digitalencia"; // Nombre de la carpeta en Drive

function doPost(e) {
  const lock = LockService.getScriptLock();
  lock.tryLock(10000); 

  // --- DEBUGGING: LOG TO SHEET ---
  let debugSheet;
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    debugSheet = ss.getSheetByName("Logs");
    if (!debugSheet) {
      debugSheet = ss.insertSheet("Logs");
      debugSheet.appendRow(["Timestamp", "Type", "Data/Error"]);
    }
  } catch(e) {
    // If we can't open the sheet, we can't log.
    return ContentService.createTextOutput("Critical Error: Cannot access Spreadsheet. Check ID.");
  }

  try {
    const jsonString = e.parameter.payload; 
    let payloadToLog = jsonString;
    
    if (!jsonString && e.postData && e.postData.contents) {
      payloadToLog = e.postData.contents;
    }

    debugSheet.appendRow([new Date(), "Incoming Request", payloadToLog || "No Payload"]);

    // Reuse parsing logic
    let finalJsonString = jsonString;
    if (!finalJsonString && e.postData && e.postData.contents) {
      finalJsonString = e.postData.contents;
    }

    if (!finalJsonString) throw new Error("No payload received");

    const fullData = JSON.parse(finalJsonString);
    const sheetData = fullData.sheetData;
    const rawData = fullData.raw;

    if (!sheetData || !rawData) throw new Error("Invalid JSON Structure");

    // 1. GENERAR PDF
    const pdfFile = createInvoicePDF(rawData, sheetData);
    const pdfUrl = pdfFile.getUrl();

    // 2. ENVIAR EMAIL AL CLIENTE (Si existe)
    if (sheetData.clientEmail) {
      try {
        const subject = `Factura ${sheetData.invoiceNumber} - ${rawData.issuer.brand}`;
        const body = `Estimado cliente,\n\nAdjunto encontrará la factura Nº ${sheetData.invoiceNumber} correspondiente a los servicios prestados.\n\nAtentamente,\n${rawData.issuer.name}`;
        
        GmailApp.sendEmail(sheetData.clientEmail, subject, body, {
          attachments: [pdfFile.getAs(MimeType.PDF)],
          name: rawData.issuer.brand
        });
        debugSheet.appendRow([new Date(), "Email Sent", "To: " + sheetData.clientEmail]);
      } catch (emailError) {
        debugSheet.appendRow([new Date(), "Email Error", emailError.toString()]);
      }
    }

    // 3. ACTUALIZAR SHEET (insertar en la primera fila libre de la columna A)
    const sheet = getSheet();
    const newRow = [
      sheetData.invoiceNumber,
      sheetData.issueDate,
      sheetData.clientName,
      sheetData.clientTaxId,
      sheetData.baseTotal,
      sheetData.vatTypes,
      sheetData.vatTotalFormatted,
      sheetData.irpfPercent,
      sheetData.irpfAmountFormatted,
      sheetData.grandTotal,
      `=HYPERLINK("${pdfUrl}"; "Factura")`
    ];

    const lastRowA = sheet.getRange("A:A").getValues().filter(r => r[0] !== "").length;
    // lastRowA incluye el encabezado, así que si solo está la cabecera será 1 → insertará en la fila 2
    const targetRow = Math.max(2, lastRowA + 1);

    sheet.getRange(targetRow, 1, 1, newRow.length).setValues([newRow]);
    debugSheet.appendRow([new Date(), "Success", `Row ${targetRow} added for ${sheetData.invoiceNumber}`]);

    // 4. ACTUALIZAR RESUMEN FISCAL
    recalcResumenFiscal();

    return ContentService.createTextOutput("Success");

  } catch (error) {
    if(debugSheet) debugSheet.appendRow([new Date(), "Error", error.toString()]);
    return ContentService.createTextOutput("Error: " + error.toString());
  } finally {
    lock.releaseLock();
  }
}

// --- FUNCIÓN RECÁLCULO RESUMEN FISCAL (Integración AppSheet) ---
function recalcResumenFiscal() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName(SHEET_NAME);
  if (!sheet) return;

  const lastRowA = sheet.getRange("A:A").getValues().filter(r => r[0] !== "").length;
  if (lastRowA < 2) return; // solo cabecera

  // Facturas desde fila 2 hasta lastRowA
  const dataRange = sheet.getRange(2, 5, lastRowA - 1, 6); // E..J
  const data = dataRange.getValues();

  let sumBase = 0, sumIva = 0, sumIrpf = 0, sumTotal = 0;

  for (let i = 0; i < data.length; i++) {
    const row = data[i];
    sumBase += parseEuro(row[0]); // E
    sumIva  += parseEuro(row[2]); // G
    sumIrpf += parseEuro(row[4]); // I
    sumTotal+= parseEuro(row[5]); // J
  }

  const targets = [
    { label: "Base Imponible", value: sumBase },
    { label: "Total IVA", value: sumIva },
    { label: "Retención IRPF", value: sumIrpf },
    { label: "TOTAL NETO", value: sumTotal }
  ];

  const labelRange = sheet.getRange("N1:N30");
  const labels = labelRange.getValues();

  for (let t = 0; t < targets.length; t++) {
    const target = targets[t];
    for (let i = 0; i < labels.length; i++) {
      const cellValue = String(labels[i][0]);
      if (cellValue && cellValue.includes(target.label)) {
        sheet.getRange(i + 1, 15).setValue(target.value).setNumberFormat("#,##0.00 €"); // O
        break;
      }
    }
  }
}

// --- HELPER PARSEO MONEDA ROBUSTO ---
function parseEuro(value) {
  if (value == null || value === "") return 0;
  if (typeof value === 'number') return value;
  let s = String(value);
  s = s.replace(/[€\s]/g, '');
  s = s.replace(/\./g, '');
  s = s.replace(/,/g, '.');
  const result = parseFloat(s);
  return isNaN(result) ? 0 : result;
}

// --- FUNCIÓN GENERADORA DE PDF ---
function createInvoicePDF(data, formattedData) {
  const folders = DriveApp.getFoldersByName(FOLDER_NAME);
  let folder;
  if (folders.hasNext()) {
    folder = folders.next();
  } else {
    folder = DriveApp.createFolder(FOLDER_NAME);
  }

  const htmlTemplate = `
    <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; padding: 40px; color: #333; max-width: 800px; margin: 0 auto; background-color: white;">
      <!-- HEADER -->
      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
         <!-- IZQUIERDA: LOGO + CAJA AZUL -->
         <!-- IZQUIERDA: LOGO + CAJA AZUL (USANDO TABLES PARA PDF ROBUST) -->
         <table style="border-collapse: collapse; margin-right: 20px;">
               <td style="padding: 0 15px 0 0; vertical-align: middle;">
                  ${formattedData.logoBase64 ? 
                    `<img src="${formattedData.logoBase64}" alt="Logo" width="64" height="64" style="width: 64px; height: 64px; display: block;" />` : ''
                  }
               </td>
               <td style="padding: 0; vertical-align: middle;">
                  <div style="background-color: #0066FF !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; color: white !important; padding: 15px 25px; min-width: 180px; text-align: center;">
                     <h2 style="margin: 0; font-size: 20px; font-weight: bold; letter-spacing: 1px; color: white !important;">${data.issuer.brand.toUpperCase()}</h2>
                  </div>
               </td>
         </table>
         
         <!-- DERECHA: DATOS EMISOR -->
         <div style="text-align: right; font-size: 12px; color: #444;">
            <h3 style="margin: 0 0 5px 0; font-size: 14px; text-transform: uppercase; color: #000;">${data.issuer.name ? data.issuer.name.toUpperCase() : ''}</h3>
            <p style="margin: 2px 0; white-space: pre-line;">${data.issuer.address}</p>
            <p style="margin: 2px 0;">${data.issuer.taxIdLabel}: ${data.issuer.taxId}</p>
            <p style="margin: 2px 0;">Tel. ${data.issuer.phone}</p>
            <p style="margin: 2px 0;">Email ${data.issuer.email}</p>
         </div>
      </div>

      <!-- SEPARADOR Y TÍTULO -->
      <hr style="border: 0; border-top: 4px solid #000; margin: 20px 0 30px 0;" />
      <h1 style="margin: 0 0 30px 0; font-size: 28px; font-weight: bold; color: #000; text-transform: uppercase;">FACTURA</h1>

      <!-- GRID INFO (3 COLUMNAS) -->
      <div style="display: flex; justify-content: space-between; margin-bottom: 40px; font-size: 12px;">
         <!-- COL 1: CLIENTE -->
         <div style="width: 32%;">
            <h4 style="margin: 0 0 10px 0; font-weight: bold; color: #000;">Datos de cliente</h4>
            <div style="color: #333;">
               <p style="margin: 0 0 5px 0; font-weight: bold; font-size: 13px;">${data.client.name}</p>
               <p style="margin: 0 0 5px 0; white-space: pre-line;">${data.client.address}</p>
               <p style="margin: 0;">${data.client.taxIdLabel}: ${data.client.taxId}</p>
            </div>
         </div>

         <!-- COL 2: REFERENCIA -->
         <div style="width: 32%;">
            <h4 style="margin: 0 0 10px 0; font-weight: bold; color: #000;">Referencia</h4>
            <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
               <tr>
                  <td style="padding: 2px 0; color: #666;">Nº Factura:</td>
                  <td style="padding: 2px 0; font-weight: 500; text-align: right;">${formattedData.invoiceNumber}</td>
               </tr>
               <tr>
                  <td style="padding: 2px 0; color: #666;">Fecha:</td>
                  <td style="padding: 2px 0; font-weight: 500; text-align: right;">${formattedData.issueDate}</td>
               </tr>
               <tr>
                  <td style="padding: 2px 0; color: #666;">Ref. Cliente:</td>
                  <td style="padding: 2px 0; font-weight: 500; text-align: right;">${data.client.ref || "-"}</td>
               </tr>
            </table>
         </div>

         <!-- COL 3: PAGO -->
         <div style="width: 32%;">
            <h4 style="margin: 0 0 10px 0; font-weight: bold; color: #000;">Pago</h4>
            <p style="margin: 0 0 5px 0;"><span style="color: #666;">Método:</span> ${data.invoice.paymentMethod}</p>
            ${data.invoice.iban ? `<p style="margin: 0 0 5px 0;"><span style="color: #666;">IBAN:</span> <span style="font-family: monospace; background: #f5f5f5; padding: 2px;">${data.invoice.iban}</span></p>` : ''}
            ${data.invoice.dueDate ? `<p style="margin: 0;"><span style="color: #666;">Vencimiento:</span> <strong>${formattedData.dueDate || data.invoice.dueDate}</strong></p>` : ''}
         </div>
      </div>

      <!-- TABLA DE ITEMS -->
      <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 11px;">
        <thead>
          <tr style="border-top: 2px solid #000; border-bottom: 2px solid #000; color: #000;">
            <th style="padding: 10px 5px; text-align: center; font-weight: bold; width: 40px;">POS</th>
            <th style="padding: 10px 5px; text-align: center; font-weight: bold; width: 60px;">CÓD.</th>
            <th style="padding: 10px 5px; text-align: left; font-weight: bold;">DESCRIPCIÓN</th>
            <th style="padding: 10px 5px; text-align: center; font-weight: bold; width: 50px;">CANT.</th>
            <th style="padding: 10px 5px; text-align: center; font-weight: bold; width: 50px;">IVA</th>
            <th style="padding: 10px 5px; text-align: right; font-weight: bold; width: 80px;">PRECIO UN.</th>
            <th style="padding: 10px 5px; text-align: right; font-weight: bold; width: 80px;">TOTAL</th>
          </tr>
        </thead>
        <tbody>
          ${data.items.map((item, i) => {
             // Logic for fake code (copy from frontend)
             let code = "SRV-00";
             if (item.packId === 'inicio_digital') code = "PCK-01";
             else if (item.packId === 'automatizacion') code = "PCK-02";
             else if (item.packId === 'medida') code = "PCK-03";
             
             return `
             <tr style="border-bottom: 1px solid #eee;">
               <td style="padding: 12px 5px; text-align: center; color: #666;">${i + 1}</td>
               <td style="padding: 12px 5px; text-align: center; color: #666;">${code}</td>
               <td style="padding: 12px 5px;">
                 <strong style="font-size: 12px; color: #000;">${item.title}</strong>
                 ${item.detail ? `<br><span style="color: #666; font-size: 10px; line-height: 1.4;">${item.detail}</span>` : ''}
               </td>
               <td style="padding: 12px 5px; text-align: center; color: #000;">${item.qty}</td>
               <td style="padding: 12px 5px; text-align: center; color: #000;">${item.vatPercent}%</td>
               <td style="padding: 12px 5px; text-align: right; color: #000;">${item.unitPrice.toFixed(2)} €</td>
               <td style="padding: 12px 5px; text-align: right; font-weight: bold; color: #000;">${(item.qty * item.unitPrice).toFixed(2)} €</td>
             </tr>
          `}).join('')}
        </tbody>
      </table>

      <!-- TOTALES -->
      <div>
         <hr style="border: 0; border-top: 1px solid #000; margin-bottom: 20px;" />
         
         <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <!-- DESGLOSE IVA (IZQUIERDA) -->
            <div style="width: 45%;">
               <table style="width: 100%; font-size: 11px; border-collapse: collapse;">
                  <thead>
                     <tr style="border-bottom: 1px solid #000; color: #000;">
                        <th style="text-align: left; padding: 5px 0;">Tipo IVA</th>
                        <th style="text-align: right; padding: 5px 0;">Base</th>
                        <th style="text-align: right; padding: 5px 0;">Cuota</th>
                     </tr>
                  </thead>
                  <tbody>
                     <!-- NOTE: Backend receives plain text formatted vatTypes/total. 
                          Ideally backend data should have array of breakdown. 
                          For now we might not have exact breakdown array in 'formattedData'.
                          We'll try to use data if available or skip. 
                          Actually, GAS receives raw 'sheetData' which has comma separated vat types.
                          Strictly speaking, recreating the table purely from summary strings is hard.
                          However, 'data.totals.vatBreakdown' SHOULD follow if passed correctly.
                          Let's assume 'data.raw.totals' is passed in 'data' argument in GAS function.
                          In doPost: createInvoicePDF(rawData, sheetData). 
                          So 'data' param IS 'rawData' from frontend.
                          Frontend passes: raw: { ...state, totals } 
                          So data.totals.vatBreakdown should be available!
                     -->
                     ${data.totals && data.totals.vatBreakdown ? data.totals.vatBreakdown.map(row => `
                     <tr style="color: #555;">
                        <td style="padding: 5px 0;">${row.percent}%</td>
                        <td style="padding: 5px 0; text-align: right;">${row.base.toFixed(2)} €</td>
                        <td style="padding: 5px 0; text-align: right;">${row.quota.toFixed(2)} €</td>
                     </tr>
                     `).join('') : '<tr><td colspan="3">Ver detalles totales</td></tr>'}
                  </tbody>
               </table>
            </div>

            <!-- TOTALES GENERALES (DERECHA) -->
            <div style="width: 40%; font-size: 13px;">
               <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                  <span style="color: #666;">Base Imponible:</span>
                  <span style="font-weight: 500;">${formattedData.baseTotal}</span>
               </div>
               <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                  <span style="color: #666;">+ Total IVA:</span>
                  <span style="font-weight: 500;">${formattedData.vatTotalFormatted}</span>
               </div>
               ${data.taxes.applyIrpf ? `
               <div style="display: flex; justify-content: space-between; margin-bottom: 10px; color: #d00;">
                  <span>- IRPF (${formattedData.irpfPercent}):</span>
                  <span style="font-weight: 500;">-${formattedData.irpfAmountFormatted}</span>
               </div>` : ''}
               
               <div style="display: flex; justify-content: space-between; margin-top: 15px; padding-top: 10px; border-top: 2px solid #000; font-size: 18px; font-weight: bold; color: #000;">
                  <span>TOTAL A PAGAR</span>
                  <span>${formattedData.grandTotal}</span>
               </div>
            </div>
         </div>
      </div>

      <div style="margin-top: 50px; padding-top: 20px; border-top: 1px solid #eee; font-size: 10px; color: #888;">
         <p style="font-weight: bold; margin-bottom: 5px; color: #666;">Notas:</p>
         <div style="line-height: 1.5;">${data.invoice.notes ? data.invoice.notes.replace(/\n/g, '<br>') : ''}</div>
      </div>
    </div>
  `;

  const fileName = `Factura ${formattedData.invoiceNumber} - ${data.client.name}.pdf`;
  const blob = Utilities.newBlob(htmlTemplate, MimeType.HTML, fileName).getAs(MimeType.PDF);
  const file = folder.createFile(blob);
  file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
  return file;
}

function getSheet() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  let sheet = ss.getSheetByName(SHEET_NAME);
  if (!sheet) {
    sheet = ss.insertSheet(SHEET_NAME);
    sheet.appendRow(["Nº Factura", "Fecha Emisión", "Cliente", "NIF Cliente", "Base Imponible", "% IVA", "Total IVA", "% IRPF", "Retención IRPF", "TOTAL", "Link PDF"]);
    sheet.setFrozenRows(1);
    sheet.getRange(1, 1, 1, 11).setFontWeight("bold");
    updateSummarySkeleton(sheet);
  }
  return sheet;
}

function updateSummarySkeleton(sheet) {
  const startRow = 2;
  const colIndex = 14; 
  const headerRange = sheet.getRange(startRow, colIndex, 1, 2);
  headerRange.setBackground("#1155cc").setFontColor("#ffffff").setFontWeight("bold").setHorizontalAlignment("center");
  const bodyRange = sheet.getRange(startRow + 1, colIndex, 4, 2);
  bodyRange.setBackground("#f3f3f3").setFontColor("#000000").setBorder(true, true, true, true, true, true);
  sheet.getRange(startRow, colIndex).setValue("RESUMEN FISCAL");
  const labels = [["Base Imponible"], ["Total IVA"], ["Retención IRPF"], ["TOTAL NETO"]];
  sheet.getRange(startRow + 1, colIndex, 4, 1).setValues(labels).setFontWeight("bold");
}

// ==========================================
// NUEVA FUNCIONALIDAD: FILTRO POR FECHAS (V2)
// ==========================================

function onOpen() {
  SpreadsheetApp.getUi()
    .createMenu('Facturación')
    .addItem('Configurar Filtros de Fecha', 'setupDateFilters')
    .addItem('Calcular Total IVA (Manual)', 'forceCalculateIva')
    .addToUi();
}

// Configura los dropdowns y cabeceras en Q2-R2
function setupDateFilters() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_NAME);
  if (!sheet) {
    SpreadsheetApp.getUi().alert("No se encontró la hoja: " + SHEET_NAME);
    return;
  }

  // Cabeceras
  sheet.getRange("Q1").setValue("Desde Fecha").setFontWeight("bold").setBackground("#d9ead3");
  sheet.getRange("R1").setValue("Hasta Fecha").setFontWeight("bold").setBackground("#d9ead3");
  sheet.getRange("S1").setValue("Total IVA Rango").setFontWeight("bold").setBackground("#fff2cc");

  // Validación de datos (Dropdown fechas) en Q2 y R2
  // Usamos un validador de fecha más permisivo
  const rule = SpreadsheetApp.newDataValidation().requireDate().setAllowInvalid(true).build();
  sheet.getRange("Q2:R2").setDataValidation(rule);
  
  sheet.getRange("S2").setValue(0).setNumberFormat("#,##0.00 €");
  
  SpreadsheetApp.getUi().alert("Filtros configurados. Introduce fechas en Q2 y R2.");
}

// Trigger automático al editar celdas
function onEdit(e) {
  if (!e || !e.source) return;
  const sheet = e.source.getActiveSheet();
  if (sheet.getName() !== SHEET_NAME) return;

  const range = e.range;
  const row = range.getRow();
  const col = range.getColumn();

  // "Desde" = Q2 (17), "Hasta" = R2 (18)
  if (row === 2 && (col === 17 || col === 18)) {
    // Pequeño delay visual o toast
    e.source.toast("Calculando nuevo total...", "Facturación", 3);
    calculateIvaByDateRange(sheet);
  }
}

// Función manual para botón de menú
function forceCalculateIva() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_NAME);
  if (!sheet) return;
  
  SpreadsheetApp.getActiveSpreadsheet().toast("Iniciando cálculo...", "Status");
  calculateIvaByDateRange(sheet);
}

// Lógica de cálculo
function calculateIvaByDateRange(sheet) {
  const fromDateRaw = sheet.getRange("Q2").getValue();
  const toDateRaw = sheet.getRange("R2").getValue();
  const outputCell = sheet.getRange("S2");

  const fromDate = parseDateHelper(fromDateRaw);
  const toDate = parseDateHelper(toDateRaw);

  if (!fromDate || !toDate) {
    // Solo reseteamos si ambas están vacías. Si hay una, esperamos a la otra.
    // O mostramos mensaje de error en la celda
    if (!fromDateRaw && !toDateRaw) outputCell.setValue(0);
    return;
  }
  
  // Normalizar horas para comparar solo FECHAS
  fromDate.setHours(0,0,0,0);
  toDate.setHours(23,59,59,999);

  const lastRow = sheet.getLastRow();
  if (lastRow < 2) {
    outputCell.setValue(0);
    return;
  }

  // Rango desde fila 2 hasta final.
  // Col B (2) -> Col G (7)
  const dataRange = sheet.getRange(2, 2, lastRow - 1, 6);
  const values = dataRange.getValues();

  let totalIva = 0;
  let count = 0;

  for (let i = 0; i < values.length; i++) {
    // values[i][0] = Fecha Emisión
    // values[i][5] = Total IVA
    const rowDateRaw = values[i][0];
    const rowIvaRaw = values[i][5];

    const rowDate = parseDateHelper(rowDateRaw);

    if (rowDate) {
      // Normalizar hora fila
      rowDate.setHours(12,0,0,0); // Mediodía para evitar problemas de timezone

      if (rowDate >= fromDate && rowDate <= toDate) {
        totalIva += parseEuro(rowIvaRaw);
        count++;
      }
    }
  }

  outputCell.setValue(totalIva).setNumberFormat("#,##0.00 €");
  SpreadsheetApp.getActiveSpreadsheet().toast(`Cálculo completado. ${count} facturas encontradas.`, "Éxito");
}

function parseDateHelper(val) {
  if (!val) return null;
  if (val instanceof Date) return val;
  
  // Si es cadena
  if (typeof val === 'string') {
    // Caso DD/MM/YYYY
    if (val.includes('/')) {
      const parts = val.split('/');
      if (parts.length === 3) {
         // Asegurar que son números
         const d = parseInt(parts[0], 10);
         const m = parseInt(parts[1], 10) - 1; // Mes 0-index
         const y = parseInt(parts[2], 10);
         const dateObj = new Date(y, m, d);
         // Validar que es fecha válida
         if (!isNaN(dateObj.getTime())) return dateObj;
      }
    }
    // Caso ISO YYYY-MM-DD
    if (val.includes('-')) {
        const parts = val.split('-');
        if (parts.length === 3) {
            return new Date(parts[0], parts[1]-1, parts[2]);
        }
    }
  }
  
  // Fallback
  const d = new Date(val);
  return isNaN(d.getTime()) ? null : d;
}
